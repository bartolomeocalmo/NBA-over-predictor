<!doctype html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NBA Over Predictor Pro - Automatic Betting</title>

    <!-- PWA -->
    <link rel="manifest" href="./manifest.json" />
    <meta name="theme-color" content="#3b82f6" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="NBA Predictor" />

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="/firebase-config.js"></script>

    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-2.34.0.min.js"></script>

    <link rel="stylesheet" href="css/main.css" />
  </head>
  <body>
    <!-- HEADER -->
    <div class="header">
      <div class="logo">
        <img
          src="logo.png"
          alt="NBA Over Predictor"
          style="width: auto; display: block"
        />
      </div>
      <div class="user-section">
        <!-- THEME TOGGLE -->
        <button onclick="toggleTheme()" class="theme-toggle" id="themeToggle">
          <span id="themeIcon">üåô</span>
          <span id="themeText">Dark</span>
        </button>

        <div id="loggedOutSection">
          <button onclick="handleLogin()" class="btn">Login con Google</button>
        </div>

        <div id="loggedInSection" style="display: none">
          <img id="userAvatar" class="user-avatar" />
          <span id="userName" style="font-weight: 600"></span>
          <span
            id="planBadge"
            class="plan-badge free"
            onclick="
              if (userPlan === 'free') window.location = '/premium.html';
            "
            style="cursor: pointer"
            title="Passa a Premium"
            >Free</span
          >
          <button onclick="showDashboard()" class="btn btn-secondary">
            Dashboard
          </button>
          <button onclick="handleLogout()" class="btn btn-secondary">
            Logout
          </button>
        </div>
      </div>
    </div>

    <!-- LANDING VIEW ‚Äî mostrata agli utenti non loggati -->
    <div id="landingView" class="view active">

      <!-- ‚îÄ‚îÄ HERO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="ld-hero">
        <div class="ld-hero-left">
          <div class="ld-eyebrow">
            <span class="ld-live-dot"></span>
            Analisi statistica NBA in tempo reale
          </div>
          <h1 class="ld-h1">
            Scommetti sull'Over NBA<br>
            con dati <span class="ld-h1-accent">statistici reali</span>
          </h1>
          <div class="ld-hero-badge">üèÄ Gratis per sempre</div>
          <p class="ld-lead ld-lead-hero">
            La prossima partita merita un'analisi seria.
          </p>
          <div class="ld-cta-row">
            <button onclick="handleLogin()" class="ld-btn-primary ld-btn-glow">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
              Inizia gratis con Google
            </button>
            <span class="ld-cta-note">Nessuna carta richiesta</span>
          </div>
        </div>

        <div class="ld-hero-right">
          <!-- Mockup analisi -->
          <div class="ld-mockup">
            <div class="ld-mockup-header">
              <div class="ld-mockup-dot" style="background:#ef4444"></div>
              <div class="ld-mockup-dot" style="background:#f59e0b"></div>
              <div class="ld-mockup-dot" style="background:#10b981"></div>
              <span class="ld-mockup-title">Analisi ‚Äî LeBron James</span>
            </div>
            <div class="ld-mockup-body">
              <div class="ld-mockup-row">
                <span class="ld-mk-label">Giocatore</span>
                <span class="ld-mk-value">LeBron James</span>
              </div>
              <div class="ld-mockup-row">
                <span class="ld-mk-label">Soglia Over</span>
                <span class="ld-mk-value">27.5 punti</span>
              </div>
              <div class="ld-mockup-row">
                <span class="ld-mk-label">Quota bookmaker</span>
                <span class="ld-mk-value">1.85</span>
              </div>
              <div class="ld-mockup-divider"></div>
              <div class="ld-mockup-result">
                <div class="ld-result-prob">
                  <div class="ld-result-num" id="ldAnimProb">0%</div>
                  <div class="ld-result-lbl">Probabilit√† Over</div>
                </div>
                <div class="ld-result-prob">
                  <div class="ld-result-num ld-green" id="ldAnimKelly">‚Ç¨0</div>
                  <div class="ld-result-lbl">Stake Kelly su ‚Ç¨100</div>
                </div>
              </div>
              <div class="ld-mockup-bar-wrap">
                <div class="ld-mockup-bar" id="ldAnimBar"></div>
              </div>
              <div class="ld-mockup-verdict" id="ldAnimVerdict">
                <span class="ld-verdict-badge">‚è≥ Calcolo...</span>
              </div>
            </div>
          </div>
        </div>
      </div>


      <!-- ‚îÄ‚îÄ COME FUNZIONA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="ld-section">
        <div class="ld-section-label">Il metodo</div>
        <h2 class="ld-section-title">Inizia a scommettere con criterio</h2>
        <p class="ld-problem-sub">Smetti di affidarti all'istinto. Le scommesse vincenti nel lungo periodo sono quelle dove la probabilit√† reale supera quella implicita nella quota ‚Äî e dove punti la giusta percentuale del tuo bankroll.</p>
        <div class="ld-steps">
          <div class="ld-step">
            <div class="ld-step-num">1</div>
            <div class="ld-step-icon">üîç</div>
            <div class="ld-step-title">Trova la probabilit√† reale</div>
            <div class="ld-step-desc">Cerca il giocatore: l'app analizza lo storico della stagione e calcola staticamente quante volte ha superato quella soglia di punti.</div>
          </div>
          <div class="ld-step-arrow">‚Üí</div>
          <div class="ld-step">
            <div class="ld-step-num">2</div>
            <div class="ld-step-icon">‚öñÔ∏è</div>
            <div class="ld-step-title">Confronta con la quota</div>
            <div class="ld-step-desc">Inserisci la quota del bookmaker. Se la nostra probabilit√† √® pi√π alta di quella implicita nella quota, la scommessa ha <strong>valore atteso positivo</strong>.</div>
          </div>
          <div class="ld-step-arrow">‚Üí</div>
          <div class="ld-step">
            <div class="ld-step-num">3</div>
            <div class="ld-step-icon">üí°</div>
            <div class="ld-step-title">Punta con il Kelly</div>
            <div class="ld-step-desc">Il metodo Kelly calcola esattamente quanto del tuo bankroll rischiare per massimizzare la crescita nel lungo periodo, evitando di bruciarlo in poche serate.</div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ KELLY SPIEGATO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="ld-section ld-kelly-section">
        <div class="ld-kelly-wrap">
          <div class="ld-kelly-left">
            <div class="ld-section-label">Perch√© il Kelly</div>
            <h2 class="ld-kelly-title">Il metodo che usano i trader professionisti</h2>
            <p class="ld-kelly-text">Il <strong>criterio di Kelly</strong> √® una formula matematica nata nel 1956, usata da hedge fund, trader quantitativi e scommettitori professionisti di tutto il mondo.</p>
            <p class="ld-kelly-text">L'idea √® semplice: se hai un vantaggio su una scommessa, esiste una percentuale ottimale del tuo capitale da rischiare. Puntare di pi√π ti espone alla rovina; puntare di meno lascia profitti sul tavolo.</p>
            <p class="ld-kelly-text">NBA Over Predictor calcola questa percentuale per ogni analisi, adattandola al tuo bankroll attuale e al numero di scommesse rimanenti nel progetto.</p>
          </div>
          <div class="ld-kelly-right">
            <div class="ld-kelly-card">
              <div class="ld-kelly-example-label">Esempio pratico</div>
              <div class="ld-kelly-row">
                <span>Probabilit√† stimata</span><strong>64%</strong>
              </div>
              <div class="ld-kelly-row">
                <span>Quota bookmaker</span><strong>1.90</strong>
              </div>
              <div class="ld-kelly-row">
                <span>Prob. implicita quota</span><strong>53%</strong>
              </div>
              <div class="ld-kelly-divider"></div>
              <div class="ld-kelly-row ld-kelly-highlight">
                <span>Vantaggio stimato</span><strong>+11%</strong>
              </div>
              <div class="ld-kelly-row ld-kelly-result">
                <span>Stake consigliato su ‚Ç¨200</span><strong class="ld-kelly-stake">‚Ç¨14.20</strong>
              </div>
              <div class="ld-kelly-note">Non troppo, non troppo poco. Matematicamente ottimale.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ STATS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="ld-stats-bar">
        <div class="ld-stat">
          <div class="ld-stat-num">450+</div>
          <div class="ld-stat-lbl">Giocatori NBA analizzabili</div>
        </div>
        <div class="ld-stat-sep"></div>
        <div class="ld-stat">
          <div class="ld-stat-num">ML</div>
          <div class="ld-stat-lbl">Modello machine learning</div>
        </div>
        <div class="ld-stat-sep"></div>
        <div class="ld-stat">
          <div class="ld-stat-num">Kelly</div>
          <div class="ld-stat-lbl">Metodo staking ottimizzato</div>
        </div>
        <div class="ld-stat-sep"></div>
        <div class="ld-stat">
          <div class="ld-stat-num">‚Ç¨0</div>
          <div class="ld-stat-lbl">Per iniziare</div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ PRICING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="ld-section">
        <div class="ld-section-label">Piani</div>
        <h2 class="ld-section-title">Semplice e trasparente</h2>
        <div class="ld-pricing">
          <div class="ld-plan">
            <div class="ld-plan-name">Free</div>
            <div class="ld-plan-price">‚Ç¨0 <span>/ mese</span></div>
            <div class="ld-plan-desc">Per iniziare e testare il modello</div>
            <ul class="ld-plan-features">
              <li><span class="ldf-check">‚úì</span> Analisi scommessa NBA</li>
              <li><span class="ldf-check">‚úì</span> Calcolo stake Kelly</li>
              <li><span class="ldf-check">‚úì</span> Storico eventi</li>
              <li><span class="ldf-limit">‚ö†</span> 2 progetti al mese</li>
              <li><span class="ldf-limit">‚ö†</span> 5 ricerche automatiche / giorno</li>
            </ul>
            <button onclick="handleLogin()" class="ld-plan-btn ld-plan-btn-free">Inizia gratis</button>
          </div>

          <div class="ld-plan ld-plan-premium">
            <div class="ld-plan-popular">‚≠ê PI√ô SCELTO</div>
            <div class="ld-plan-name">Premium</div>
            <div class="ld-plan-price">‚Ç¨4,90 <span>/ mese</span></div>
            <div class="ld-plan-desc">Per chi scommette con costanza</div>
            <ul class="ld-plan-features">
              <li><span class="ldf-check">‚úì</span> Tutto del piano Free</li>
              <li><span class="ldf-check">‚úì</span> Progetti illimitati</li>
              <li><span class="ldf-check">‚úì</span> Ricerche illimitate</li>
              <li><span class="ldf-check">‚úì</span> Badge Premium ‚≠ê</li>
              <li><span class="ldf-check">‚úì</span> Cancella quando vuoi</li>
            </ul>
            <button onclick="window.location='/premium.html'" class="ld-plan-btn ld-plan-btn-premium">Passa a Premium</button>
          </div>
        </div>
      </div>


      <!-- ‚îÄ‚îÄ TESTIMONIANZE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="ld-section">
        <div class="ld-section-label">Utenti beta</div>
        <h2 class="ld-section-title">Cosa dicono gli utenti</h2>
        <div class="ld-testi-minimal">

          <div class="ld-testi-quote">
            <div class="ld-tq-mark">"</div>
            <p>Il Kelly mi ha cambiato l'approccio. Non brucio pi√π il bankroll in una sera.</p>
            <div class="ld-tq-author">‚Äî Marco R.</div>
          </div>

          <div class="ld-testi-quote ld-tq-featured">
            <div class="ld-tq-mark">"</div>
            <p>30 secondi e sai gi√† se la scommessa vale. Non ho trovato niente di simile per l'NBA.</p>
            <div class="ld-tq-author">‚Äî Simone T.</div>
          </div>

          <div class="ld-testi-quote">
            <div class="ld-tq-mark">"</div>
            <p>Con il piano free ho gi√† tutto quello che mi serve per analizzare prima di puntare.</p>
            <div class="ld-tq-author">‚Äî Luca D.</div>
          </div>

        </div>
        <p class="ld-testi-disclaimer">* Testimonianze di utenti beta. I risultati passati non garantiscono profitti futuri.</p>
      </div>

      <!-- ‚îÄ‚îÄ FAQ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="ld-section">
        <div class="ld-section-label">FAQ</div>
        <h2 class="ld-section-title">Domande frequenti</h2>
        <div class="ld-faqs">
          <details class="ld-faq">
            <summary class="ld-faq-q">√à legale usare questo strumento in Italia?</summary>
            <div class="ld-faq-a">S√¨. NBA Over Predictor √® uno strumento di analisi statistica, non un servizio di scommesse. Fornisce probabilit√† basate su dati storici per supportare decisioni informate, esattamente come fa un analista sportivo. La responsabilit√† delle scommesse √® sempre dell'utente.</div>
          </details>
          <details class="ld-faq">
            <summary class="ld-faq-q">Come funziona il modello di machine learning?</summary>
            <div class="ld-faq-a">Il modello analizza lo storico partite del giocatore (punti segnati, minuti giocati, avversario, casa/trasferta) e stima la probabilit√† che superi la soglia indicata. Viene poi confrontata con la probabilit√† implicita della quota del bookmaker per valutare se la scommessa ha valore atteso positivo.</div>
          </details>
          <details class="ld-faq">
            <summary class="ld-faq-q">Cosa √® il metodo Kelly e perch√© √® utile?</summary>
            <div class="ld-faq-a">Il criterio di Kelly √® una formula matematica che calcola la percentuale ottimale del bankroll da scommettere basandosi sulla probabilit√† stimata e sulla quota. Evita di over-puntare (che porta a rovina nel lungo periodo) o under-puntare (che riduce i profitti attesi).</div>
          </details>
          <details class="ld-faq">
            <summary class="ld-faq-q">I dati sono aggiornati in tempo reale?</summary>
            <div class="ld-faq-a">I dati vengono scaricati direttamente dai server NBA tramite API ufficiale al momento della ricerca, quindi riflettono sempre lo storico pi√π aggiornato disponibile per la stagione corrente.</div>
          </details>
          <details class="ld-faq">
            <summary class="ld-faq-q">Posso usarlo anche per le partite di stanotte?</summary>
            <div class="ld-faq-a">S√¨. Basta cercare il giocatore, inserire la soglia Over che trovi sul tuo bookmaker e la relativa quota. L'analisi viene eseguita in tempo reale sullo storico della stagione corrente, quindi √® sempre aggiornata all'ultima partita giocata.</div>
          </details>
          <details class="ld-faq">
            <summary class="ld-faq-q">Cosa significa "valore atteso positivo"?</summary>
            <div class="ld-faq-a">Una scommessa ha valore atteso positivo quando la probabilit√† reale di vincita √® pi√π alta di quella implicita nella quota del bookmaker. Ad esempio: se la quota √® 1.90 (implica ~53%) ma il nostro modello stima il 65%, la differenza del 12% √® il tuo vantaggio statistico. Nel lungo periodo, scommettere solo su eventi con valore atteso positivo √® l'unico modo matematicamente sostenibile.</div>
          </details>
          <details class="ld-faq">
            <summary class="ld-faq-q">Posso cancellare il piano Premium quando voglio?</summary>
            <div class="ld-faq-a">S√¨, senza vincoli. Puoi disdire il piano Premium in qualsiasi momento dalla pagina account. Non ci sono penali, costi nascosti o periodi minimi di abbonamento. Dopo la disdetta, il tuo account torna automaticamente al piano Free.</div>
          </details>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ FINAL CTA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="ld-final-cta">
        <div class="ld-final-glow"></div>
        <div class="ld-final-inner">
          <div class="ld-final-badge">üèÄ Gratis per sempre</div>
          <h2 class="ld-final-title">La prossima partita<br>merita un'analisi seria.</h2>
          <p class="ld-final-sub">Accedi in 10 secondi. Nessuna carta di credito richiesta.<br>Inizia a usare il piano Free oggi stesso.</p>
          <div class="ld-final-actions">
            <button onclick="handleLogin()" class="ld-btn-primary ld-btn-large ld-btn-glow">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
              Inizia gratis con Google
            </button>
            <button onclick="window.location='/premium.html'" class="ld-final-secondary-btn">
              Scopri Premium ‚Ç¨4,90/mese ‚Üí
            </button>
          </div>
          <div class="ld-final-features">
            <span>‚úì 5 analisi al giorno</span>
            <span>‚úì Calcolo Kelly automatico</span>
            <span>‚úì Storico eventi</span>
            <span>‚úì Nessuna carta</span>
          </div>
        </div>
      </div>





    </div>

    <!-- DASHBOARD VIEW -->
    <div id="dashboardView" class="view">
      <div class="dashboard-header">
        <div class="dashboard-title">I Miei Progetti</div>
        <button
          onclick="openNewProjectModal()"
          class="btn"
          style="background: white; color: #667eea"
        >
          + Nuovo Progetto
        </button>
      </div>

      <div class="projects-grid" id="projectsGrid"></div>
    </div>

    <!-- PREDICTOR VIEW -->
    <div id="predictorView" class="view">
      <div class="container">
        <!-- ACTIVE PROJECT BANNER -->
        <div
          id="activeProjectBanner"
          style="display: none"
          class="active-project-banner"
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: flex-start;
              flex-wrap: wrap;
              gap: 12px;
            "
          >
            <div>
              <h3 id="activeProjectName">Progetto</h3>
              <div class="active-project-stats">
                <div class="active-project-stat">
                  <div class="active-project-stat-value" id="activeBankroll">
                    --
                  </div>
                  <div class="active-project-stat-label">Bankroll Corrente</div>
                </div>
                <div class="active-project-stat">
                  <div class="active-project-stat-value" id="activeProgress">
                    --
                  </div>
                  <div class="active-project-stat-label">Eventi</div>
                </div>
                <div class="active-project-stat">
                  <div class="active-project-stat-value" id="activeProfit">
                    --
                  </div>
                  <div class="active-project-stat-label">Profitto</div>
                </div>
                <div class="active-project-stat">
                  <div class="active-project-stat-value" id="activeTarget">
                    --
                  </div>
                  <div class="active-project-stat-label">Target</div>
                </div>
              </div>
            </div>
            <div
              style="
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                justify-content: flex-end;
                flex-shrink: 0;
              "
            >
              <button
                onclick="showDashboard()"
                class="btn btn-secondary"
                style="white-space: nowrap"
              >
                Cambia Progetto
              </button>
              <button
                onclick="deleteActiveProject()"
                class="btn"
                style="background: #f56565; white-space: nowrap"
              >
                üóëÔ∏è Elimina
              </button>
            </div>
          </div>

          <!-- Target info (sempre visibile) -->
          <div
            id="activeTargetInfo"
            style="
              display: none;
              margin-top: 14px;
              padding: 10px 14px;
              border-radius: 8px;
              font-size: 13px;
            "
          ></div>
        </div>

        <!-- INFO NO PROJECT -->
        <div id="noProjectInfo" class="info-message">
          ‚ÑπÔ∏è <strong>Nessun progetto attivo.</strong> Fai il Login e salva i
          tuoi progetti!
        </div>

        <h1 style="font-size: 28px; font-weight: 800; margin-bottom: 24px">
          NBA Over Predictor
        </h1>

        <!-- CSV LOADING -->
        <div style="font-size: 20px; font-weight: 700; margin-bottom: 16px">
          üìä 1. Carica Dati Giocatore
        </div>

        <!-- AUTOCOMPLETE SEARCH -->
        <div style="margin-bottom: 20px; position: relative">
          <label
            style="
              display: block;
              font-size: 14px;
              font-weight: 600;
              margin-bottom: 8px;
            "
          >
            üîé Cerca giocatore NBA
          </label>
          <!-- CONTATORE RICERCHE (solo free) -->
          <div id="searchLimitBar" class="limit-bar" style="display: none">
            <div class="dots" id="searchDots"></div>
            <span id="searchLimitText"></span>
          </div>
          <!-- BANNER UPGRADE quando esaurite -->
          <div
            id="searchLimitBanner"
            class="upgrade-banner"
            style="display: none"
          >
            <p>
              üîí Ricerche automatiche esaurite per oggi. Ricaricano tra
              <strong id="searchResetCountdown"></strong>.<br />
              Oppure usa il <strong>CSV manuale</strong> qui sotto.
            </p>
            <button
              class="btn-upgrade"
              onclick="window.location = '/premium.html'"
            >
              ‚≠ê Passa a Premium
            </button>
          </div>
          <div style="position: relative">
            <input
              type="text"
              id="playerSearchInput"
              class="form-input"
              placeholder="Es. LeBron, Curry, Wembanyama..."
              autocomplete="off"
              style="margin-bottom: 0"
              oninput="onPlayerSearch(this.value)"
              onkeydown="onSearchKeyDown(event)"
            />
            <!-- DROPDOWN RISULTATI -->
            <div
              id="searchDropdown"
              style="
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: var(--bg-card);
                color: var(--text-primary);
                border: 2px solid var(--accent-primary);
                border-top: none;
                border-radius: 0 0 8px 8px;
                z-index: 100;
                max-height: 260px;
                overflow-y: auto;
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
              "
            ></div>
          </div>

          <!-- STATO CARICAMENTO -->
          <div
            id="playerSearchStatus"
            style="margin-top: 10px; display: none"
          ></div>
        </div>

        <!-- FALLBACK MANUALE ‚Äî nascosto di default, mostrato solo se ricerche esaurite o errore API -->
        <div id="manualCsvSection" style="display:none; margin-bottom: 24px;">
          <div style="
              color: #667eea;
              font-weight: 600;
              padding: 8px 0;
            ">
            üìù Alternativa: Incolla CSV manuale da Basketball Reference
          </div>
          <!-- LINK GUIDA CSV -->
          <div style="margin: 12px 0 4px">
            <a
              href="/guida-csv.html"
              target="_blank"
              style="
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 10px 16px;
                background: rgba(59, 130, 246, 0.1);
                border: 1px solid rgba(59, 130, 246, 0.3);
                border-radius: 8px;
                color: #93c5fd;
                font-size: 13px;
                font-weight: 600;
                text-decoration: none;
                transition: background 0.2s;
              "
              onmouseover="this.style.background = 'rgba(59,130,246,0.2)'"
              onmouseout="this.style.background = 'rgba(59,130,246,0.1)'"
            >
              üìñ Leggi la guida passo-passo con screenshot ‚Üí
            </a>
          </div>
          <div style="margin-top: 12px">
            <textarea
              id="manualCsv"
              class="form-input"
              style="height: 100px; font-family: monospace; font-size: 12px"
              placeholder="Incolla CSV da Basketball Reference..."
            ></textarea>
            <button onclick="loadManualCsv()" class="btn-primary-full">
              Carica CSV
            </button>
          </div>
        </div>

        <div class="success-message" id="playerLoadedMsg"></div>
        <div class="error-message" id="errorMsg"></div>

        <!-- AUTOMATED ANALYSIS -->
        <div style="margin-top: 32px">
          <div style="font-size: 20px; font-weight: 700; margin-bottom: 16px">
            ü§ñ 2. Analisi Scommessa
          </div>

          <div
            style="
              display: grid;
              grid-template-columns: repeat(2, 1fr);
              gap: 16px;
              margin-bottom: 16px;
            "
          >
            <div>
              <label
                style="
                  display: block;
                  font-size: 14px;
                  font-weight: 600;
                  margin-bottom: 8px;
                "
                >Soglia Punti Over</label
              >
              <input
                type="number"
                id="pointLine"
                class="form-input"
                step="0.5"
                placeholder="28.5"
              />
            </div>
            <div>
              <label
                style="
                  display: block;
                  font-size: 14px;
                  font-weight: 600;
                  margin-bottom: 8px;
                "
                >Quota Bookmaker</label
              >
              <input
                type="number"
                id="odds"
                class="form-input"
                value="1.90"
                step="0.05"
              />
            </div>
          </div>

          <button
            onclick="analyzeAutomaticBet()"
            class="btn-primary-full"
            id="btnAnalyze"
            disabled
          >
            üîç ANALIZZA SCOMMESSA
          </button>

          <!-- ANALYSIS RESULT ‚Äî stile mockup card -->
          <div id="analysisResult" style="display: none; margin-top: 28px">

            <!-- Damage control warning (inserito via JS se necessario) -->

            <div class="ld-mockup" style="max-width: 100%; animation: none;">
              <!-- Header macOS dots -->
              <div class="ld-mockup-header">
                <div class="ld-mockup-dot" style="background:#ef4444"></div>
                <div class="ld-mockup-dot" style="background:#f59e0b"></div>
                <div class="ld-mockup-dot" style="background:#10b981"></div>
                <span class="ld-mockup-title" id="mockupTitle">Analisi</span>
              </div>

              <div class="ld-mockup-body">
                <!-- Riepilogo input -->
                <div class="ld-mockup-row">
                  <span class="ld-mk-label">Giocatore</span>
                  <span class="ld-mk-value" id="recapPlayer">‚Äî</span>
                </div>
                <div class="ld-mockup-row">
                  <span class="ld-mk-label">Soglia Over</span>
                  <span class="ld-mk-value" id="recapThreshold">‚Äî</span>
                </div>
                <div class="ld-mockup-row">
                  <span class="ld-mk-label">Quota bookmaker</span>
                  <span class="ld-mk-value" id="recapOdds">‚Äî</span>
                </div>
                <div class="ld-mockup-row">
                  <span class="ld-mk-label">Affidabilit√†</span>
                  <span class="ld-mk-value" id="confidenceBadge">‚Äî</span>
                </div>

                <div class="ld-mockup-divider"></div>

                <!-- Risultati principali -->
                <div class="ld-mockup-result">
                  <div class="ld-result-prob">
                    <div class="ld-result-num" id="probResult">‚Äî</div>
                    <div class="ld-result-lbl" id="probLabel">Probabilit√† Over</div>
                  </div>
                  <div class="ld-result-prob" id="stakeDisplay" style="display:none">
                    <div class="ld-result-num ld-green" id="autoStake">‚Äî</div>
                    <div class="ld-result-lbl" id="stakeInfo">Stake Kelly</div>
                  </div>
                </div>

                <!-- Barra probabilit√† -->
                <div class="ld-mockup-bar-wrap">
                  <div class="ld-mockup-bar" id="resultBar"></div>
                </div>

                <!-- Mini stats (vincita / ROI / % bankroll) ‚Äî solo se consigliata -->
                <div id="miniStats" style="display:none; display:none; margin: 10px 0; gap: 0">
                  <div style="display:grid; grid-template-columns: repeat(3,1fr); gap:8px; margin-bottom:12px;">
                    <div style="text-align:center; background:rgba(255,255,255,0.05); border-radius:8px; padding:8px 4px;">
                      <div style="font-size:11px; color:var(--text-muted); margin-bottom:3px;">Vincita pot.</div>
                      <div style="font-size:15px; font-weight:700; color:#10b981;" id="potentialWin">‚Äî</div>
                    </div>
                    <div style="text-align:center; background:rgba(255,255,255,0.05); border-radius:8px; padding:8px 4px;">
                      <div style="font-size:11px; color:var(--text-muted); margin-bottom:3px;">ROI</div>
                      <div style="font-size:15px; font-weight:700; color:#3b82f6;" id="potentialROI">‚Äî</div>
                    </div>
                    <div style="text-align:center; background:rgba(255,255,255,0.05); border-radius:8px; padding:8px 4px;">
                      <div style="font-size:11px; color:var(--text-muted); margin-bottom:3px;">% Bankroll</div>
                      <div style="font-size:15px; font-weight:700; color:#a78bfa;" id="stakePercentage">‚Äî</div>
                    </div>
                  </div>
                </div>

                <!-- Verdict / bottone -->
                <div id="betDecision">
                  <!-- Verdict badge e bottone inseriti via JS -->
                  <div class="ld-mockup-verdict" id="verdictWrap">
                    <span class="ld-verdict-badge" id="decisionTitle">‚è≥ Calcolo...</span>
                  </div>
                  <div id="decisionReason" style="font-size:12px; color:var(--text-muted); margin-top:6px; text-align:center;"></div>

                  <!-- Bottone aggiungi al progetto -->
                  <button
                    onclick="confirmAndAddEvent()"
                    id="btnConfirmEvent"
                    class="btn-primary-full"
                    style="display:none; margin-top:14px; background: linear-gradient(135deg, #10b981 0%, #059669 100%);"
                  >
                    ‚úÖ Aggiungi al Progetto
                  </button>
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- EVENTS HISTORY -->
        <div
          id="eventsHistorySection"
          style="display: none"
          class="events-history"
        >
          <h3 style="margin-bottom: 16px">üìã Storico Eventi</h3>
          <div id="eventsList"></div>
        </div>
      </div>
    </div>

    <!-- /predictorView -->
    </div>

<script>
      // STATE
      let currentUser = null;
      let userPlan = "free"; // "free" | "premium"

      // ============================================================
      // FREEMIUM LIMITS
      // ============================================================

      const FREE_SEARCHES_PER_DAY = 5;
      const FREE_PROJECTS_PER_MONTH = 2;

      // Chiave usage Firestore per i progetti del mese corrente
      function monthKey() {
        const d = new Date();
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
      }

      // Legge piano utente da Firestore
      async function loadUserPlan() {
        if (!currentUser || !db) return;
        try {
          const snap = await db.collection("users").doc(currentUser.uid).get();
          userPlan =
            snap.exists && snap.data().plan === "premium" ? "premium" : "free";
        } catch (e) {
          console.warn("[loadUserPlan] errore Firestore:", e);
          userPlan = "free";
        }
        updatePlanBadge();
        // updateSearchLimitUI accede a elementi del predictorView ‚Äî chiamata sicura
        try { await updateSearchLimitUI(); } catch(e) { console.warn("[loadUserPlan] updateSearchLimitUI:", e); }
      }

      function updatePlanBadge() {
        const badge = document.getElementById("planBadge");
        if (!badge) return;
        if (userPlan === "premium") {
          badge.className = "plan-badge premium";
          badge.innerHTML = "‚≠ê Premium";
        } else {
          badge.className = "plan-badge free";
          badge.innerHTML = "Free";
        }
      }

      // ‚îÄ‚îÄ RICERCHE GIORNALIERE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

      async function getSearchUsage() {
        if (!currentUser || !db) return { count: 0, reset_at: 0 };
        try {
          const snap = await db
            .collection("users")
            .doc(currentUser.uid)
            .collection("usage")
            .doc("searches_daily")
            .get();
          if (!snap.exists) return { count: 0, reset_at: 0 };
          return snap.data();
        } catch (e) {
          return { count: 0, reset_at: 0 };
        }
      }

      async function incrementSearchUsage() {
        if (!currentUser || !db) return;
        const now = Date.now();
        const usage = await getSearchUsage();
        const isExpired = now >= (usage.reset_at || 0);
        const newCount = isExpired ? 1 : (usage.count || 0) + 1;
        const newResetAt = isExpired
          ? now + 24 * 60 * 60 * 1000
          : usage.reset_at;
        await db
          .collection("users")
          .doc(currentUser.uid)
          .collection("usage")
          .doc("searches_daily")
          .set({ count: newCount, reset_at: newResetAt });
        return { count: newCount, reset_at: newResetAt };
      }

      async function canSearch() {
        if (userPlan === "premium") return true;
        const usage = await getSearchUsage();
        const now = Date.now();
        if (now >= (usage.reset_at || 0)) return true; // reset avvenuto
        return (usage.count || 0) < FREE_SEARCHES_PER_DAY;
      }

      async function updateSearchLimitUI() {
        const $g = (id) => document.getElementById(id);
        if (!$g("searchLimitBar")) return; // predictorView non ancora visibile

        if (userPlan === "premium") {
          $g("searchLimitBar").style.display = "none";
          $g("searchLimitBanner").style.display = "none";
          if ($g("playerSearchInput")) $g("playerSearchInput").disabled = false;
          return;
        }

        const usage = await getSearchUsage();
        const now = Date.now();
        const isExpired = now >= (usage.reset_at || 0);
        const used = isExpired ? 0 : usage.count || 0;
        const remaining = FREE_SEARCHES_PER_DAY - used;
        const limitBar    = $g("searchLimitBar");
        const limitBanner = $g("searchLimitBanner");

        if (remaining <= 0) {
          if (limitBar)    limitBar.style.display = "none";
          if (limitBanner) limitBanner.style.display = "flex";
          if ($g("playerSearchInput")) {
            $g("playerSearchInput").disabled = true;
            $g("playerSearchInput").placeholder = "Ricerche esaurite ‚Äî usa il CSV manuale";
          }
          showManualCsv();
          startSearchCountdown(usage.reset_at);
        } else {
          if (limitBanner) limitBanner.style.display = "none";
          if (limitBar)    limitBar.style.display = "flex";
          if ($g("playerSearchInput")) {
            $g("playerSearchInput").disabled = false;
            $g("playerSearchInput").placeholder = "Es. LeBron, Curry, Wembanyama...";
          }
          const dotsEl = $g("searchDots");
          if (dotsEl) {
            dotsEl.innerHTML = "";
            for (let i = 0; i < FREE_SEARCHES_PER_DAY; i++) {
              const dot = document.createElement("div");
              dot.className = "dot " + (i < used ? "used" : (remaining === 1 && i === used ? "last" : ""));
              dotsEl.appendChild(dot);
            }
          }
          if ($g("searchLimitText")) {
            $g("searchLimitText").innerText = remaining === 1
              ? "‚ö†Ô∏è Ultima ricerca automatica rimasta oggi"
              : `${remaining} ricerche automatiche rimaste oggi`;
          }
        }
      }

      let countdownInterval = null;
      function startSearchCountdown(resetAt) {
        if (countdownInterval) clearInterval(countdownInterval);
        const el = document.getElementById("searchResetCountdown");
        function update() {
          const diff = Math.max(0, resetAt - Date.now());
          const h = Math.floor(diff / 3600000);
          const m = Math.floor((diff % 3600000) / 60000);
          const s = Math.floor((diff % 60000) / 1000);
          if (el)
            el.innerText = `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
          if (diff === 0) {
            clearInterval(countdownInterval);
            updateSearchLimitUI();
          }
        }
        update();
        countdownInterval = setInterval(update, 1000);
      }

      // ‚îÄ‚îÄ PROGETTI MENSILI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

      async function getMonthlyProjectCount() {
        if (!currentUser || !db) return 0;
        try {
          const snap = await db
            .collection("users")
            .doc(currentUser.uid)
            .collection("usage")
            .doc(monthKey())
            .get();
          if (!snap.exists) return 0;
          return snap.data().projects_created || 0;
        } catch (e) {
          return 0;
        }
      }

      async function incrementMonthlyProjectCount() {
        try {
          const ref = db
            .collection("users")
            .doc(currentUser.uid)
            .collection("usage")
            .doc(monthKey());
          await ref.set(
            { projects_created: firebase.firestore.FieldValue.increment(1) },
            { merge: true },
          );
        } catch(e) {
          console.warn("[usage] incrementMonthlyProjectCount fallito:", e);
        }
      }
      let currentCSV = null;
      let currentProbability = null;
      let currentConfidence = null;
      let currentPlayerName = null;
      let currentThreshold = null;
      let currentOdds = null;
      let currentAutoStake = null;
      let currentRecommended = false;
      let activeProject = null;
      let auth = null;
      let db = null;
      let firebaseEnabled = false;

      // ============================================
      // THEME MANAGEMENT
      // ============================================

      // Initialize theme on page load
      function initTheme() {
        const savedTheme = localStorage.getItem("theme") || "dark";
        document.body.setAttribute("data-theme", savedTheme);
        updateThemeButton(savedTheme);
      }

      // Toggle between dark and light theme
      function toggleTheme() {
        const currentTheme = document.body.getAttribute("data-theme") || "dark";
        const newTheme = currentTheme === "dark" ? "light" : "dark";

        document.body.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        updateThemeButton(newTheme);
      }

      // Update theme button text and icon
      function updateThemeButton(theme) {
        const iconEl = document.getElementById("themeIcon");
        const textEl = document.getElementById("themeText");

        if (theme === "dark") {
          iconEl.textContent = "üåô";
          textEl.textContent = "Dark";
        } else {
          iconEl.textContent = "‚òÄÔ∏è";
          textEl.textContent = "Light";
        }
      }

      // Init theme immediately
      initTheme();

      // FIREBASE INIT
      function initFirebase() {
        try {
          if (typeof firebase === "undefined") return false;
          // Inizializza se non ancora fatto
          if (!firebase.apps.length) {
            console.warn("Firebase non ancora inizializzato");
            return false;
          }
          auth = firebase.auth();
          db = firebase.firestore();
          firebaseEnabled = true;
          auth.onAuthStateChanged((user) => {
            currentUser = user;
            if (user) {
              onUserLoggedIn(user);
            } else {
              onUserLoggedOut();
            }
          });
          return true;
        } catch (e) {
          console.warn("Firebase init error:", e);
          return false;
        }
      }

      window.addEventListener("DOMContentLoaded", () => {
        // firebase-config.js √® nell'head quindi √® gi√† eseguito qui
        if (!initFirebase()) {
          console.log("Firebase non disponibile ‚Äî modalit√† offline");
          showPredictor();
        }
      });

      // AUTH
      async function handleLogin() {
        try {
          // Reinizializza se auth √® null (es. dopo cache clear)
          if (!auth) initFirebase();
          if (!auth) {
            alert("Firebase non disponibile. Ricarica la pagina e riprova.");
            return;
          }
          const provider = new firebase.auth.GoogleAuthProvider();
          await auth.signInWithPopup(provider);
        } catch (error) {
          alert("Errore login: " + error.message);
        }
      }

      async function handleLogout() {
        if (confirm("Sei sicuro?")) {
          await auth.signOut();
        }
      }

      function onUserLoggedIn(user) {
        document.getElementById("loggedOutSection").style.display = "none";
        document.getElementById("loggedInSection").style.display = "flex";
        document.getElementById("loggedInSection").style.gap = "12px";
        document.getElementById("loggedInSection").style.alignItems = "center";
        document.getElementById("userName").innerText = user.displayName;
        document.getElementById("userAvatar").src = user.photoURL;
        document.getElementById("landingView").classList.remove("active");
        loadUserPlan(); // carica piano e aggiorna UI
        showDashboard();
        loadUserProjects();
      }

      function onUserLoggedOut() {
        document.getElementById("loggedOutSection").style.display = "block";
        document.getElementById("loggedInSection").style.display = "none";
        // Mostra landing page
        document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
        document.getElementById("landingView").classList.add("active");
      }

      // VIEWS
      function showDashboard() {
        document
          .querySelectorAll(".view")
          .forEach((v) => v.classList.remove("active"));
        document.getElementById("dashboardView").classList.add("active");
        loadUserProjects();
      }

      function showPredictor() {
        document
          .querySelectorAll(".view")
          .forEach((v) => v.classList.remove("active"));
        document.getElementById("predictorView").classList.add("active");
        updateActiveProjectBanner();
        updateEventsHistory();
        // Ora che predictorView √® visibile, aggiorna i limiti ricerche
        updateSearchLimitUI().catch(e => console.warn("[showPredictor] updateSearchLimitUI:", e));
      }

      // ============================================================
      // AUTOCOMPLETE GIOCATORI
      // ============================================================

      let searchTimeout = null;
      let selectedPlayerId = null;
      let highlightIdx = -1;

      function onPlayerSearch(query) {
        selectedPlayerId = null;
        clearTimeout(searchTimeout);
        closeDropdown();

        if (query.trim().length < 2) return;

        searchTimeout = setTimeout(() => fetchSearchResults(query.trim()), 200);
      }

      async function fetchSearchResults(query) {
        try {
          const res = await fetch("/search_players", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query }),
          });
          const data = await res.json();
          renderDropdown(data.results || []);
        } catch (e) {
          console.error("Errore ricerca:", e);
        }
      }

      function renderDropdown(results) {
        const dropdown = document.getElementById("searchDropdown");
        highlightIdx = -1;

        if (!results.length) {
          closeDropdown();
          return;
        }

        dropdown.innerHTML = results
          .map(
            (r, i) => `
          <div
            class="search-item"
            data-idx="${i}"
            data-player-id="${r.player_id}"
            data-name="${r.name}"
            onclick="selectPlayer('${r.player_id}', '${r.name}')"
            onmouseover="highlightItem(${i})"
            style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 14px; display: flex; justify-content: space-between; align-items: center;"
          >
            <span>üèÄ ${r.name}</span>
            <span style="font-size: 11px; color: #a0aec0;">NBA</span>
          </div>
        `,
          )
          .join("");

        dropdown.style.display = "block";
      }

      function highlightItem(idx) {
        document.querySelectorAll(".search-item").forEach((el, i) => {
          el.style.background = i === idx ? "var(--bg-card-hover)" : "";
        });
        highlightIdx = idx;
      }

      function closeDropdown() {
        const dd = document.getElementById("searchDropdown");
        if (dd) dd.style.display = "none";
        highlightIdx = -1;
      }

      function onSearchKeyDown(e) {
        const items = document.querySelectorAll(".search-item");
        if (!items.length) return;

        if (e.key === "ArrowDown") {
          e.preventDefault();
          highlightIdx = Math.min(highlightIdx + 1, items.length - 1);
          items.forEach(
            (el, i) =>
              (el.style.background =
                i === highlightIdx ? "var(--bg-card-hover)" : ""),
          );
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          highlightIdx = Math.max(highlightIdx - 1, 0);
          items.forEach(
            (el, i) =>
              (el.style.background =
                i === highlightIdx ? "var(--bg-card-hover)" : ""),
          );
        } else if (e.key === "Enter" && highlightIdx >= 0) {
          e.preventDefault();
          const item = items[highlightIdx];
          selectPlayer(item.dataset.playerId, item.dataset.name);
        } else if (e.key === "Escape") {
          closeDropdown();
        }
      }

      // Chiude dropdown cliccando fuori
      document.addEventListener("click", (e) => {
        if (
          !e.target.closest("#playerSearchInput") &&
          !e.target.closest("#searchDropdown")
        ) {
          closeDropdown();
        }
      });


      // ‚îÄ‚îÄ Helper: mostra/nascondi manualCsvSection in modo sicuro ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function showManualCsv() {
        const el = document.getElementById("manualCsvSection");
        if (el) el.style.display = "block";
      }
      function hideManualCsv() {
        const el = document.getElementById("manualCsvSection");
        if (el) el.style.display = "none";
      }

      async function selectPlayer(playerId, name) {
        closeDropdown();

        // Elemento status ‚Äî mostrato durante tutto il processo
        const statusEl = document.getElementById("playerSearchStatus");

        function setStatus(msg, type) {
          // type: 'loading' | 'success' | 'error'
          const colors = {
            loading: { bg: "#bee3f8", color: "#2c5282" },
            success: { bg: "#c6f6d5", color: "#22543d" },
            error:   { bg: "#fed7d7", color: "#742a2a" },
          };
          const c = colors[type] || colors.loading;
          statusEl.style.display    = "block";
          statusEl.style.background = c.bg;
          statusEl.style.color      = c.color;
          statusEl.style.padding    = "10px 14px";
          statusEl.style.borderRadius = "8px";
          statusEl.style.fontSize   = "14px";
          statusEl.style.marginTop  = "10px";
          statusEl.innerHTML = msg;
        }

        // ‚îÄ‚îÄ Controllo limite ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let allowed = true;
        try { allowed = await canSearch(); } catch(e) { allowed = true; }
        if (!allowed) {
          try { await updateSearchLimitUI(); } catch(_) {}
          return;
        }

        selectedPlayerId = playerId;
        if (document.getElementById("playerSearchInput"))
          document.getElementById("playerSearchInput").value = name;

        // Reset UI
        currentCSV = null;
        currentPlayerName = null;
        const loadedMsg = document.getElementById("playerLoadedMsg");
        if (loadedMsg) { loadedMsg.style.display = "none"; loadedMsg.innerText = ""; }
        const btnAnalyze = document.getElementById("btnAnalyze");
        if (btnAnalyze) btnAnalyze.disabled = true;
        const analysisResult = document.getElementById("analysisResult");
        if (analysisResult) analysisResult.style.display = "none";
        hideError();
        hideManualCsv();

        // Incrementa contatore
        try { await incrementSearchUsage(); } catch(e) { console.warn("[usage]", e); }
        try { await updateSearchLimitUI(); } catch(e) {}

        // ‚îÄ‚îÄ Fetch dati giocatore ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        setStatus(`‚è≥ Scaricando dati di <strong>${name}</strong> dalla NBA API...`, "loading");

        let data;
        try {
          const res = await fetch("/fetch_player_csv", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ player_id: playerId, player_name: name, season: "2026" }),
          });

          if (!res.ok) {
            setStatus(`‚ùå Errore server (${res.status}). Prova il CSV manuale.`, "error");
            showManualCsv();
            return;
          }

          data = await res.json();
        } catch (err) {
          console.error("[fetch_player_csv] errore di rete:", err);
          setStatus(`‚ùå Errore di rete: ${err.message}<br><small>Controlla la connessione o usa il CSV manuale.</small>`, "error");
          showManualCsv();
          return;
        }

        // ‚îÄ‚îÄ Risposta con errore dal backend ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        if (data.error) {
          const is403 = data.error.includes("403") || data.error.includes("bloccato");
          setStatus(
            is403
              ? `‚ùå Basketball Reference ha bloccato la richiesta.<br><small>Riprova tra qualche secondo o usa il CSV manuale.</small>`
              : `‚ùå ${data.error}<br><small>Puoi usare il CSV manuale qui sotto.</small>`,
            "error"
          );
          showManualCsv();
          return;
        }

        // ‚îÄ‚îÄ Successo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        currentCSV         = data.csv;
        currentPlayerName  = data.player_name;

        setStatus(`‚úÖ ${data.player_name} ‚Äî ${data.games} partite caricate (stagione ${data.season})`, "success");
        hideManualCsv();

        if (loadedMsg) {
          loadedMsg.innerText      = `‚úÖ ${data.player_name} ‚Äî ${data.games} partite caricate`;
          loadedMsg.style.display  = "block";
        }
        if (btnAnalyze) btnAnalyze.disabled = false;
      }

      // PROJECTS
      async function loadUserProjects() {
        if (!currentUser) return;

        try {
          const snapshot = await db
            .collection("users")
            .doc(currentUser.uid)
            .collection("projects")
            .orderBy("created_at", "desc")
            .get();

          const projects = [];
          snapshot.forEach((doc) => {
            projects.push({ id: doc.id, ...doc.data() });
          });

          displayProjects(projects);
        } catch (error) {
          console.error("Error loading projects:", error);
        }
      }

      function displayProjects(projects) {
        const grid = document.getElementById("projectsGrid");

        if (projects.length === 0) {
          grid.innerHTML =
            '<div style="color: white; text-align: center; padding: 40px; grid-column: 1/-1;">Nessun progetto. Creane uno!</div>';
          return;
        }

        grid.innerHTML = projects
          .map((p) => {
            const profit = p.bankroll_current - p.bankroll_initial;
            const progress = (p.events_played / p.total_events) * 100;

            return `
          <div class="project-card ${p.status}">
            <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
              <h3 style="font-size: 18px; font-weight: 700; cursor: pointer;" onclick="selectProject('${p.id}')">${p.name}</h3>
              <div style="display: flex; gap: 8px; align-items: center;">
                <span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; ${
                  p.status === "active"
                    ? "background: #c6f6d5; color: #22543d;"
                    : p.status === "completed"
                      ? "background: #bee3f8; color: #2c5282;"
                      : "background: #fed7d7; color: #742a2a;"
                }">
                  ${p.status === "active" ? "üü¢ Attivo" : p.status === "completed" ? "‚úÖ Completato" : "‚ùå Fallito"}
                </span>
                <button 
                  onclick="event.stopPropagation(); deleteProject('${p.id}')" 
                  style="background: #f56565; color: white; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; font-size: 12px; font-weight: 600;"
                  title="Elimina progetto"
                >
                  üóëÔ∏è
                </button>
              </div>
            </div>
            
            <div onclick="selectProject('${p.id}')" style="cursor: pointer;">
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                <div style="text-align: center; padding: 12px; background: var(--bg-input); border-radius: 8px; border: 1px solid var(--border-color);">
                  <div style="font-size: 20px; font-weight: 700; color: ${profit >= 0 ? "#48bb78" : "#f56565"}">
                    ${profit >= 0 ? "+" : ""}${profit.toFixed(2)}‚Ç¨
                  </div>
                  <div style="font-size: 11px; color: var(--text-secondary);">Profitto</div>
                </div>
                <div style="text-align: center; padding: 12px; background: var(--bg-input); border-radius: 8px; border: 1px solid var(--border-color);">
                  <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);">${p.bankroll_current.toFixed(2)}‚Ç¨</div>
                  <div style="font-size: 11px; color: var(--text-secondary);">Bankroll</div>
                </div>
              </div>
              
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; font-size: 13px; color: var(--text-secondary);">
                <div>Eventi: ${p.events_played}/${p.total_events}</div>
                <div>Vinte: ${p.events_won}</div>
                <div>Perse: ${p.events_lost}</div>
              </div>
              
              <div style="width: 100%; height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden; margin-bottom: 12px;">
                <div style="width: ${progress}%; height: 100%; background: linear-gradient(90deg, #48bb78, #38a169);"></div>
              </div>
              
              ${
                p.min_win_rate
                  ? `
              <div style="padding: 10px 14px; background: ${p.min_win_rate >= 85 ? "#feebc8" : p.min_win_rate >= 70 ? "#bee3f8" : "#c6f6d5"}; border-radius: 8px; font-size: 12px; color: ${p.min_win_rate >= 85 ? "#7c2d12" : p.min_win_rate >= 70 ? "#2c5282" : "#22543d"};">
                üìä <strong>Target info:</strong> Per +${p.target_profit}‚Ç¨ servono ~${p.wins_needed}/${p.total_events} vittorie (~${p.min_win_rate}% win rate) | ROI: ${p.target_roi}%
              </div>
              `
                  : ""
              }
            </div>
          </div>
        `;
          })
          .join("");
      }

      async function selectProject(projectId) {
        try {
          const doc = await db
            .collection("users")
            .doc(currentUser.uid)
            .collection("projects")
            .doc(projectId)
            .get();

          activeProject = { id: doc.id, ...doc.data() };
          showPredictor();
        } catch (error) {
          alert("Errore caricamento progetto: " + error.message);
        }
      }

      function openNewProjectModal() {
        document.getElementById("newProjectModal").classList.add("active");
      }

      function closeNewProjectModal() {
        document.getElementById("newProjectModal").classList.remove("active");
      }

      async function createNewProject() {
        const name =
          document.getElementById("projectName").value || "Nuovo Progetto";
        const bankroll = parseFloat(
          document.getElementById("projectBankroll").value,
        );
        const events = parseInt(document.getElementById("projectEvents").value);
        const target = parseFloat(
          document.getElementById("projectTarget").value,
        );

        if (!bankroll || !events || !target) {
          alert("Compila tutti i campi!");
          return;
        }

        // ‚îÄ‚îÄ CONTROLLO LIMITE MENSILE (solo free) ‚îÄ‚îÄ
        if (userPlan === "free") {
          const monthCount = await getMonthlyProjectCount();
          if (monthCount >= FREE_PROJECTS_PER_MONTH) {
            const d = new Date();
            const nextMonth = new Date(d.getFullYear(), d.getMonth() + 1, 1);
            const resetDate = nextMonth.toLocaleDateString("it-IT", {
              day: "numeric",
              month: "long",
            });
            if (
              !confirm(
                `üîí Hai raggiunto il limite di ${FREE_PROJECTS_PER_MONTH} progetti questo mese.\n\n` +
                  `Il contatore si azzera il ${resetDate}.\n\n` +
                  `‚≠ê Con il piano Premium puoi creare progetti illimitati!\n\n` +
                  `Vuoi saperne di pi√π sul piano Premium?`,
              )
            )
              return;
            window.location = "/premium.html";
            closeNewProjectModal();
            return;
          }
        }

        // Calculate minimum win rate needed (realistic with compounding)
        const targetROI = (target / bankroll) * 100; // 80%
        const avgOdds = 1.85;

        // Realistic calculation considering compounding
        // Each win gives ~8-10% profit on current bankroll
        // Formula empirica basata su simulazioni
        let estimatedWinsNeeded;
        let minWinRate;

        if (targetROI <= 30) {
          // Low target: ~50% win rate
          estimatedWinsNeeded = Math.ceil(events * 0.5);
          minWinRate = 50;
        } else if (targetROI <= 50) {
          // Medium target: ~60-65% win rate
          estimatedWinsNeeded = Math.ceil(events * 0.65);
          minWinRate = 65;
        } else if (targetROI <= 70) {
          // High target: ~70-75% win rate
          estimatedWinsNeeded = Math.ceil(events * 0.75);
          minWinRate = 75;
        } else if (targetROI <= 100) {
          // Very high target: ~80-85% win rate
          estimatedWinsNeeded = Math.ceil(events * 0.85);
          minWinRate = 85;
        } else {
          // Extreme target: ~90%+ win rate
          estimatedWinsNeeded = Math.ceil(events * 0.92);
          minWinRate = 92;
        }

        // Warning if target is unrealistic
        if (targetROI > 150) {
          if (
            !confirm(
              `‚ö†Ô∏è ATTENZIONE: Target estremamente ambizioso!\n\nTarget: +${target}‚Ç¨ (${targetROI.toFixed(0)}% ROI)\n\nPer raggiungere questo target con ${events} eventi servirebbe un win rate superiore al 95%.\n\n‚ùå Questo √® quasi impossibile!\n\nConsiglio forte: Riduci il target a +${(bankroll * 0.5).toFixed(0)}‚Ç¨ o meno.\n\nVuoi creare comunque il progetto?`,
            )
          ) {
            return;
          }
        } else if (minWinRate >= 85) {
          if (
            !confirm(
              `‚ö†Ô∏è Target molto ambizioso!\n\nPer raggiungere +${target}‚Ç¨ (${targetROI.toFixed(0)}% ROI) serve:\n- Vincere almeno ${estimatedWinsNeeded} eventi su ${events}\n- Win rate stimato: ~${minWinRate}%\n\nQuesto richiede selezione molto accurata delle scommesse.\n\nüí° Consiglio: target pi√π realistico = +${(bankroll * 0.4).toFixed(0)}‚Ç¨ (win rate ~60%)\n\nVuoi continuare?`,
            )
          ) {
            return;
          }
        } else if (minWinRate >= 70) {
          if (
            !confirm(
              `‚ö†Ô∏è Target ambizioso!\n\nPer raggiungere +${target}‚Ç¨ (${targetROI.toFixed(0)}% ROI) serve:\n- Vincere circa ${estimatedWinsNeeded} eventi su ${events}\n- Win rate stimato: ~${minWinRate}%\n\nRichiede buona selezione delle scommesse.\n\nVuoi continuare?`,
            )
          ) {
            return;
          }
        }

        try {
          await db
            .collection("users")
            .doc(currentUser.uid)
            .collection("projects")
            .add({
              name,
              bankroll_initial: bankroll,
              bankroll_current: bankroll,
              target_profit: target,
              total_events: events,
              events_played: 0,
              events_won: 0,
              events_lost: 0,
              status: "active",
              // Info statistiche target
              target_roi: parseFloat(targetROI.toFixed(1)),
              min_win_rate: minWinRate,
              wins_needed: estimatedWinsNeeded,
              created_at: firebase.firestore.FieldValue.serverTimestamp(),
              updated_at: firebase.firestore.FieldValue.serverTimestamp(),
              events: [],
            });

          await incrementMonthlyProjectCount();
          closeNewProjectModal();
          loadUserProjects();
          alert("‚úÖ Progetto creato!");
        } catch (error) {
          alert("Errore: " + error.message);
        }
      }

      async function deleteProject(projectId) {
        if (
          !confirm(
            "‚ö†Ô∏è Sei sicuro di voler eliminare questo progetto?\n\nTutti i dati, eventi e statistiche verranno persi definitivamente!",
          )
        ) {
          return;
        }

        try {
          await db
            .collection("users")
            .doc(currentUser.uid)
            .collection("projects")
            .doc(projectId)
            .delete();

          alert("‚úÖ Progetto eliminato con successo!");

          // Se era il progetto attivo, resettalo
          if (activeProject && activeProject.id === projectId) {
            activeProject = null;
            showDashboard();
          } else {
            loadUserProjects();
          }
        } catch (error) {
          alert("‚ùå Errore eliminazione: " + error.message);
        }
      }

      async function deleteActiveProject() {
        if (!activeProject) return;

        const projectName = activeProject.name;

        if (
          !confirm(
            `‚ö†Ô∏è Sei sicuro di voler eliminare il progetto "${projectName}"?\n\nTutti i dati verranno persi definitivamente!`,
          )
        ) {
          return;
        }

        try {
          await db
            .collection("users")
            .doc(currentUser.uid)
            .collection("projects")
            .doc(activeProject.id)
            .delete();

          alert("‚úÖ Progetto eliminato!");

          activeProject = null;
          showDashboard();
        } catch (error) {
          alert("‚ùå Errore: " + error.message);
        }
      }

      // TARGET REACHABILITY CHECK
      function checkTargetReachability(project) {
        const profit = project.bankroll_current - project.bankroll_initial;
        const targetRemaining = project.target_profit - profit;
        const eventsRemaining = project.total_events - project.events_played;

        if (eventsRemaining === 0)
          return { reachable: false, reason: "no_events" };

        // Assume average odds 1.85 and 100% win rate for remaining events
        const avgOdds = 1.85;
        const avgStake = project.bankroll_current / eventsRemaining;
        const maxPossibleProfit = avgStake * (avgOdds - 1) * eventsRemaining;

        const reachable = maxPossibleProfit >= targetRemaining;
        const winRateNeeded =
          eventsRemaining > 0
            ? Math.ceil((targetRemaining / (avgStake * (avgOdds - 1))) * 100) /
              100
            : 0;

        return {
          reachable,
          maxPossibleProfit,
          targetRemaining,
          eventsRemaining,
          winRateNeeded,
          reason: !reachable ? "mathematically_impossible" : "ok",
        };
      }

      function updateActiveProjectBanner() {
        const banner = document.getElementById("activeProjectBanner");
        const noProjectInfo = document.getElementById("noProjectInfo");

        if (activeProject) {
          const profit =
            activeProject.bankroll_current - activeProject.bankroll_initial;

          banner.style.display = "block";
          noProjectInfo.style.display = "none";

          document.getElementById("activeProjectName").innerText =
            activeProject.name;
          document.getElementById("activeBankroll").innerText =
            activeProject.bankroll_current.toFixed(2) + "‚Ç¨";
          document.getElementById("activeProgress").innerText =
            `${activeProject.events_played}/${activeProject.total_events}`;
          document.getElementById("activeProfit").innerText =
            (profit >= 0 ? "+" : "") + profit.toFixed(2) + "‚Ç¨";
          document.getElementById("activeTarget").innerText =
            "+" + activeProject.target_profit + "‚Ç¨";

          // Show target info if available
          const targetInfoEl = document.getElementById("activeTargetInfo");
          if (activeProject.min_win_rate && targetInfoEl) {
            const color =
              activeProject.min_win_rate >= 85
                ? "#7c2d12"
                : activeProject.min_win_rate >= 70
                  ? "#2c5282"
                  : "#22543d";
            const bg =
              activeProject.min_win_rate >= 85
                ? "rgba(254,235,200,0.9)"
                : activeProject.min_win_rate >= 70
                  ? "rgba(190,227,248,0.9)"
                  : "rgba(198,246,213,0.9)";
            targetInfoEl.style.display = "block";
            targetInfoEl.style.background = bg;
            targetInfoEl.style.color = color;
            targetInfoEl.innerHTML = `üìä <strong>Per raggiungere +${activeProject.target_profit}‚Ç¨</strong> servono ~${activeProject.wins_needed}/${activeProject.total_events} vittorie &nbsp;|&nbsp; Win rate necessario: ~${activeProject.min_win_rate}% &nbsp;|&nbsp; ROI target: ${activeProject.target_roi}%`;
          }

          // Rimuovi warning precedente se esiste
          const existingWarning = document.getElementById("targetWarning");
          if (existingWarning) existingWarning.remove();
          const existingCompleted = document.getElementById(
            "projectCompletedBanner",
          );
          if (existingCompleted) existingCompleted.remove();

          // Gestisci stato progetto
          if (activeProject.status === "completed") {
            // Blocca analisi - target raggiunto!
            const completedBanner = document.createElement("div");
            completedBanner.id = "projectCompletedBanner";
            completedBanner.style.cssText =
              "margin-top: 16px; padding: 16px; background: linear-gradient(135deg, #38a169, #2f855a); color: white; border-radius: 10px; font-size: 15px; text-align: center;";
            const finalProfit =
              activeProject.bankroll_current - activeProject.bankroll_initial;
            completedBanner.innerHTML = `
              <div style="font-size: 28px; margin-bottom: 8px;">üèÜ</div>
              <div style="font-weight: 800; font-size: 18px; margin-bottom: 6px;">Progetto Completato!</div>
              <div style="opacity: 0.95; margin-bottom: 12px;">Hai raggiunto il target di <strong>+${activeProject.target_profit}‚Ç¨</strong></div>
              <div style="font-size: 22px; font-weight: 800; margin-bottom: 12px;">Profitto finale: +${finalProfit.toFixed(2)}‚Ç¨</div>
              <button onclick="showDashboard()" class="btn" style="background: white; color: #276749; font-weight: 700; margin-top: 4px;">
                Vai ai Progetti
              </button>
            `;
            banner.appendChild(completedBanner);

            // Disabilita tutto il form di analisi
            document.getElementById("btnAnalyze").disabled = true;
            document.getElementById("btnAnalyze").innerText =
              "üèÜ Target Raggiunto";
            document.getElementById("playerSearchInput").disabled = true;
            const pointLineEl = document.getElementById("pointLine");
            if (pointLineEl) pointLineEl.disabled = true;
            const oddsEl = document.getElementById("odds");
            if (oddsEl) oddsEl.disabled = true;
          } else if (activeProject.status === "failed") {
            // Progetto fallito
            const failedBanner = document.createElement("div");
            failedBanner.id = "projectCompletedBanner";
            failedBanner.style.cssText =
              "margin-top: 16px; padding: 16px; background: linear-gradient(135deg, #e53e3e, #c53030); color: white; border-radius: 10px; font-size: 15px; text-align: center;";
            const finalProfit =
              activeProject.bankroll_current - activeProject.bankroll_initial;
            failedBanner.innerHTML = `
              <div style="font-size: 28px; margin-bottom: 8px;">‚ùå</div>
              <div style="font-weight: 800; font-size: 18px; margin-bottom: 6px;">Progetto Concluso</div>
              <div style="opacity: 0.95; margin-bottom: 12px;">Target non raggiunto</div>
              <div style="font-size: 22px; font-weight: 800; margin-bottom: 12px;">Risultato: ${finalProfit >= 0 ? "+" : ""}${finalProfit.toFixed(2)}‚Ç¨</div>
              <button onclick="showDashboard()" class="btn" style="background: white; color: #c53030; font-weight: 700;">
                Vai ai Progetti
              </button>
            `;
            banner.appendChild(failedBanner);

            document.getElementById("btnAnalyze").disabled = true;
            document.getElementById("btnAnalyze").innerText =
              "Progetto Concluso";
          } else {
            // Progetto attivo - check raggiungibilit√† target
            const reachability = checkTargetReachability(activeProject);
            if (!reachability.reachable && activeProject.events_played > 0) {
              const warning = document.createElement("div");
              warning.id = "targetWarning";
              warning.style.cssText =
                "margin-top: 16px; padding: 16px; background: #fed7d7; color: #742a2a; border-radius: 8px; font-size: 14px;";
              warning.innerHTML = `
                <div style="font-weight: 700; margin-bottom: 8px;">‚ö†Ô∏è Target non pi√π raggiungibile matematicamente</div>
                <div style="font-size: 13px;">
                  Profitto massimo possibile: +${reachability.maxPossibleProfit.toFixed(2)}‚Ç¨<br>
                  <strong>Obiettivo: minimizzare le perdite</strong>
                </div>
              `;
              banner.appendChild(warning);
            }

            // Riabilita form se era disabilitato
            document.getElementById("btnAnalyze").disabled = !currentCSV;
            document.getElementById("btnAnalyze").innerText =
              "üìä Analizza Scommessa";
            document.getElementById("playerSearchInput").disabled = false;
            const pointLineEl = document.getElementById("pointLine");
            if (pointLineEl) pointLineEl.disabled = false;
            const oddsEl = document.getElementById("odds");
            if (oddsEl) oddsEl.disabled = false;
          }
        } else {
          banner.style.display = "none";
          noProjectInfo.style.display = "block";
        }
      }

      // CSV LOADING
      function loadManualCsv() {
        const csv = document.getElementById("manualCsv").value.trim();

        if (!csv) {
          showError("CSV vuoto!");
          return;
        }

        const lines = csv.split("\n").filter((l) => l.trim());
        if (lines.length < 2) {
          showError("CSV non valido");
          return;
        }

        currentCSV = csv;
        currentPlayerName = "Giocatore";

        document.getElementById("playerLoadedMsg").innerText =
          `‚úÖ CSV caricato: ${lines.length - 1} partite`;
        document.getElementById("playerLoadedMsg").style.display = "block";
        document.getElementById("btnAnalyze").disabled = false;
        hideError();
      }

      // AUTOMATIC BET ANALYSIS
      async function analyzeAutomaticBet() {
        // RESET risultati analisi precedente
        document.getElementById("analysisResult").style.display = "none";
        const _sd = document.getElementById("stakeDisplay");
        if (_sd) _sd.style.display = "none";
        const _bc = document.getElementById("btnConfirmEvent");
        if (_bc) _bc.style.display = "none";
        const _ms = document.getElementById("miniStats");
        if (_ms) _ms.style.display = "none";
        const _bar = document.getElementById("resultBar");
        if (_bar) { _bar.style.width = "0%"; }
        const _dt = document.getElementById("decisionTitle");
        if (_dt) { _dt.innerText = "‚è≥ Calcolo..."; _dt.removeAttribute("style"); }
        const _dr = document.getElementById("decisionReason");
        if (_dr) _dr.innerText = "";
        currentProbability = null;
        currentConfidence = null;
        currentAutoStake = null;
        currentRecommended = false;

        const pointLine = parseFloat(
          document.getElementById("pointLine").value,
        );
        const odds = parseFloat(document.getElementById("odds").value);

        if (!currentCSV || !pointLine || !odds) {
          showError("Inserisci CSV, soglia e quota!");
          return;
        }

        if (!activeProject) {
          showError("Seleziona un progetto prima!");
          return;
        }

        // Loading state
        const btnAnalyze = document.getElementById("btnAnalyze");
        const originalText = btnAnalyze.innerText;
        btnAnalyze.disabled = true;
        btnAnalyze.innerText = "‚è≥ Analizzando...";

        try {
          // Step 1: Calculate Probability
          const probResponse = await fetch("/predict", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ csv: currentCSV, point_line: pointLine }),
          });

          const probData = await probResponse.json();

          if (probData.error) {
            showError(probData.error);
            btnAnalyze.disabled = false;
            btnAnalyze.innerText = originalText;
            return;
          }

          currentProbability = probData.probability;
          currentConfidence = probData.confidence;
          currentThreshold = pointLine;
          currentOdds = odds;

          // Display probability
          document.getElementById("probResult").innerText =
            probData.over_pct.toFixed(1) + "%";
          document.getElementById("probLabel").innerText =
            `Sopra ${pointLine} punti`;

          // Popola recap nella card mockup
          if (document.getElementById("mockupTitle"))
            document.getElementById("mockupTitle").innerText = `Analisi ‚Äî ${currentPlayerName || "Giocatore"}`;
          if (document.getElementById("recapPlayer"))
            document.getElementById("recapPlayer").innerText = currentPlayerName || "‚Äî";
          if (document.getElementById("recapThreshold"))
            document.getElementById("recapThreshold").innerText = `${pointLine} punti`;
          if (document.getElementById("recapOdds"))
            document.getElementById("recapOdds").innerText = odds;

          const confMap = {
            high: {
              text: "üü¢ Alta affidabilit√†",
              bg: "#c6f6d5",
              color: "#22543d",
            },
            medium: {
              text: "üü° Media affidabilit√†",
              bg: "#feebc8",
              color: "#7c2d12",
            },
            low: {
              text: "üî¥ Bassa affidabilit√†",
              bg: "#fed7d7",
              color: "#742a2a",
            },
          };

          const conf = confMap[probData.confidence] || confMap["medium"];
          const badge = document.getElementById("confidenceBadge");
          badge.innerText = conf.text;
          badge.style.background = conf.bg;
          badge.style.color = conf.color;

          // Step 2: Check Target Reachability
          const reachability = checkTargetReachability(activeProject);
          const damageControlMode =
            !reachability.reachable && activeProject.events_played > 0;

          // Step 3: Calculate Automatic Stake
          const bankroll = activeProject.bankroll_current;
          const eventsRemaining =
            activeProject.total_events - activeProject.events_played;
          const currentProfit =
            activeProject.bankroll_current - activeProject.bankroll_initial;
          const targetRemaining = activeProject.target_profit - currentProfit;

          // If damage control mode, use conservative target
          const effectiveTarget = damageControlMode
            ? Math.min(targetRemaining, reachability.maxPossibleProfit * 0.7)
            : targetRemaining;

          const betResponse = await fetch("/calculate_bet", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              bankroll,
              target_profit: effectiveTarget,
              total_events: eventsRemaining,
              probability: currentProbability,
              odds,
              confidence: currentConfidence,
            }),
          });

          const betData = await betResponse.json();

          // Display results
          document.getElementById("analysisResult").style.display = "block";

          const decision = document.getElementById("betDecision");
          const stakeDisplay = document.getElementById("stakeDisplay");
          const confirmBtn = document.getElementById("btnConfirmEvent");

          // Add damage control warning if needed
          if (damageControlMode) {
            const warningDiv = document.createElement("div");
            warningDiv.style.cssText =
              "padding: 12px; background: #fed7d7; color: #742a2a; border-radius: 8px; margin-bottom: 16px; font-size: 13px;";
            warningDiv.innerHTML = `
            <div style="font-weight: 700; margin-bottom: 6px;">‚ö†Ô∏è DAMAGE CONTROL MODE</div>
            <div>
              Target originale (+${activeProject.target_profit}‚Ç¨) non pi√π raggiungibile.<br>
              Profitto max possibile: +${reachability.maxPossibleProfit.toFixed(2)}‚Ç¨<br>
              <strong>Stake ridotto per proteggere bankroll rimanente.</strong>
            </div>
          `;

            const analysisContainer = document.getElementById("analysisResult");
            const existingWarning = analysisContainer.querySelector(
              "[data-damage-warning]",
            );
            if (existingWarning) {
              existingWarning.remove();
            }
            warningDiv.setAttribute("data-damage-warning", "true");
            analysisContainer.insertBefore(
              warningDiv,
              analysisContainer.firstChild,
            );
          }

          const overPct = probData.over_pct;
          const barEl = document.getElementById("resultBar");
          if (barEl) {
            const pct = Math.min(overPct, 100);
            const hue = Math.round(pct * 1.2); // 0=red, 60=yellow, 72+=green
            barEl.style.width = pct + "%";
            barEl.style.background = `hsl(${hue}, 80%, 50%)`;
            barEl.style.transition = "width 0.8s ease, background 0.8s ease";
          }

          if (betData.recommended) {
            currentAutoStake = betData.stake;
            currentRecommended = true;

            const potentialWin = betData.stake * (odds - 1);
            const roi = (potentialWin / betData.stake) * 100;
            const stakePerc = (betData.stake / bankroll) * 100;

            // Badge verdict
            const titleEl = document.getElementById("decisionTitle");
            if (titleEl) {
              titleEl.innerText = "‚úÖ Valore Positivo";
              titleEl.style.background = "rgba(16,185,129,0.15)";
              titleEl.style.color = "#10b981";
              titleEl.style.border = "1px solid rgba(16,185,129,0.3)";
            }
            document.getElementById("decisionReason").innerText = betData.reason;

            // Stake
            document.getElementById("autoStake").innerText = betData.stake.toFixed(2) + "‚Ç¨";
            document.getElementById("stakeInfo").innerText =
              `${betData.stake_percentage}% bankroll (${bankroll.toFixed(2)}‚Ç¨) ¬∑ ${eventsRemaining} eventi rimasti`;

            // Mini stats
            document.getElementById("potentialWin").innerText = "+" + potentialWin.toFixed(2) + "‚Ç¨";
            document.getElementById("potentialROI").innerText = roi.toFixed(1) + "%";
            document.getElementById("stakePercentage").innerText = stakePerc.toFixed(1) + "%";

            stakeDisplay.style.display = "flex";
            stakeDisplay.style.flexDirection = "column";
            stakeDisplay.style.alignItems = "center";

            const miniStats = document.getElementById("miniStats");
            if (miniStats) miniStats.style.display = "block";

            confirmBtn.style.display = "block";
          } else {
            currentRecommended = false;

            const titleEl = document.getElementById("decisionTitle");
            if (titleEl) {
              titleEl.innerText = "‚ùå Nessun Valore";
              titleEl.style.background = "rgba(239,68,68,0.12)";
              titleEl.style.color = "#f87171";
              titleEl.style.border = "1px solid rgba(239,68,68,0.3)";
            }
            document.getElementById("decisionReason").innerText = betData.reason;

            stakeDisplay.style.display = "none";
            const miniStats = document.getElementById("miniStats");
            if (miniStats) miniStats.style.display = "none";
            confirmBtn.style.display = "none";
          }

          // Re-enable button
          btnAnalyze.disabled = false;
          btnAnalyze.innerText = originalText;
        } catch (error) {
          showError("Errore: " + error.message);

          // Re-enable button on error
          btnAnalyze.disabled = false;
          btnAnalyze.innerText = originalText;
        }
      }

      // CONFIRM AND ADD EVENT
      async function confirmAndAddEvent() {
        if (!activeProject || !currentAutoStake || !currentRecommended) {
          alert("Dati mancanti!");
          return;
        }

        // Blocca se progetto gi√† completato/fallito
        if (activeProject.status === "completed") {
          alert("üèÜ Progetto gi√† completato! Hai raggiunto il target.");
          return;
        }
        if (activeProject.status === "failed") {
          alert("Il progetto √® concluso.");
          return;
        }

        const event = {
          id: Date.now().toString(),
          player: currentPlayerName,
          threshold: currentThreshold,
          probability: currentProbability,
          odds: currentOdds,
          stake: currentAutoStake,
          potential_profit: currentAutoStake * (currentOdds - 1),
          result: "pending",
          date_added: new Date(),
          date_resolved: null,
          notes: `Prob: ${(currentProbability * 100).toFixed(1)}%, Confidence: ${currentConfidence}, STAKE AUTO`,
        };

        try {
          await db
            .collection("users")
            .doc(currentUser.uid)
            .collection("projects")
            .doc(activeProject.id)
            .update({
              events: firebase.firestore.FieldValue.arrayUnion(event),
              updated_at: firebase.firestore.FieldValue.serverTimestamp(),
            });

          alert("‚úÖ Evento aggiunto al progetto!");

          // Reload project
          const doc = await db
            .collection("users")
            .doc(currentUser.uid)
            .collection("projects")
            .doc(activeProject.id)
            .get();
          activeProject = { id: doc.id, ...doc.data() };

          // Reset form
          document.getElementById("analysisResult").style.display = "none";
          document.getElementById("pointLine").value = "";
          document.getElementById("manualCsv").value = "";
          document.getElementById("playerLoadedMsg").style.display = "none";
          document.getElementById("btnAnalyze").disabled = true;

          currentCSV = null;
          currentProbability = null;
          currentAutoStake = null;

          updateActiveProjectBanner();
          updateEventsHistory();
        } catch (error) {
          alert("Errore: " + error.message);
        }
      }

      // EVENTS HISTORY
      function updateEventsHistory() {
        if (
          !activeProject ||
          !activeProject.events ||
          activeProject.events.length === 0
        ) {
          document.getElementById("eventsHistorySection").style.display =
            "none";
          return;
        }

        document.getElementById("eventsHistorySection").style.display = "block";

        const eventsList = document.getElementById("eventsList");
        eventsList.innerHTML = activeProject.events
          .map(
            (event, idx) => `
        <div class="event-item event-${event.result}">
          <div style="flex: 1;">
            <div style="font-weight: 700; margin-bottom: 4px;">
              ${event.player} > ${event.threshold} pts
              ${event.result === "pending" ? "‚è≥ Pending" : event.result === "won" ? "‚úÖ Vinta" : "‚ùå Persa"}
            </div>
            <div style="font-size: 13px; color: var(--text-secondary);">
              Stake: ${event.stake.toFixed(2)}‚Ç¨ | Quota: ${event.odds} | Prob: ${(event.probability * 100).toFixed(1)}%
            </div>
          </div>
          ${
            event.result === "pending"
              ? `
            <div style="display: flex; gap: 8px;">
              <button onclick="markEventResult('${event.id}', 'won')" class="btn" style="padding: 8px 16px; background: #48bb78;">
                Vinta
              </button>
              <button onclick="markEventResult('${event.id}', 'lost')" class="btn" style="padding: 8px 16px; background: #f56565;">
                Persa
              </button>
            </div>
          `
              : ""
          }
        </div>
      `,
          )
          .join("");
      }

      async function markEventResult(eventId, result) {
        if (!activeProject) return;

        try {
          const eventIndex = activeProject.events.findIndex(
            (e) => e.id === eventId,
          );
          if (eventIndex === -1) return;

          const event = activeProject.events[eventIndex];
          event.result = result;
          event.date_resolved = new Date();

          let newBankroll = activeProject.bankroll_current;
          if (result === "won") {
            newBankroll += event.potential_profit;
            activeProject.events_won += 1;
          } else {
            newBankroll -= event.stake;
            activeProject.events_lost += 1;
          }

          activeProject.events_played += 1;
          activeProject.bankroll_current = newBankroll;

          // Check status
          const totalProfit = newBankroll - activeProject.bankroll_initial;
          if (activeProject.events_played >= activeProject.total_events) {
            activeProject.status =
              totalProfit >= activeProject.target_profit
                ? "completed"
                : "failed";
          } else if (totalProfit >= activeProject.target_profit) {
            activeProject.status = "completed";
          } else if (newBankroll <= activeProject.bankroll_initial * 0.3) {
            activeProject.status = "failed";
          }

          // Update DB
          await db
            .collection("users")
            .doc(currentUser.uid)
            .collection("projects")
            .doc(activeProject.id)
            .update({
              events: activeProject.events,
              bankroll_current: newBankroll,
              events_played: activeProject.events_played,
              events_won: activeProject.events_won,
              events_lost: activeProject.events_lost,
              status: activeProject.status,
              updated_at: firebase.firestore.FieldValue.serverTimestamp(),
            });

          alert(result === "won" ? "‚úÖ Evento vinto!" : "‚ùå Evento perso");

          updateActiveProjectBanner();
          updateEventsHistory();
        } catch (error) {
          alert("Errore: " + error.message);
        }
      }

      // HELPERS
      function showError(msg) {
        document.getElementById("errorMsg").innerText = msg;
        document.getElementById("errorMsg").style.display = "block";
        setTimeout(() => {
          document.getElementById("errorMsg").style.display = "none";
        }, 5000);
      }

      function hideError() {
        document.getElementById("errorMsg").style.display = "none";
      }

      // ============================================
      // PWA INSTALL BANNER
      // ============================================
      let deferredInstallPrompt = null;

      function dismissPwaBanner() {
        document.getElementById("pwaInstallBanner").style.display = "none";
        // Non mostrare di nuovo per 7 giorni
        localStorage.setItem("pwaBannerDismissed", Date.now() + 1 * 24 * 3600 * 1000);
      }

      function shouldShowBanner() {
        const dismissed = localStorage.getItem("pwaBannerDismissed");
        if (dismissed && Date.now() < parseInt(dismissed)) return false;
        // Non mostrare se gi√† installata come PWA
        if (window.matchMedia("(display-mode: standalone)").matches) return false;
        if (window.navigator.standalone === true) return false;
        return true;
      }

      // Android / Chrome: intercetta beforeinstallprompt
      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredInstallPrompt = e;
        if (!shouldShowBanner()) return;
        const banner = document.getElementById("pwaInstallBanner");
        const androidPrompt = document.getElementById("pwaAndroidPrompt");
        banner.style.display = "block";
        androidPrompt.style.display = "flex";
      });

      document.addEventListener("DOMContentLoaded", () => {
        // iOS: rileva Safari su iOS (non Chrome/Firefox su iOS)
        const isIos = /iphone|ipad|ipod/i.test(navigator.userAgent);
        const isInStandaloneMode = window.navigator.standalone === true;
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        if (isIos && !isInStandaloneMode && isSafari && shouldShowBanner()) {
          // Mostra dopo 3 secondi per non essere aggressivi
          setTimeout(() => {
            const banner = document.getElementById("pwaInstallBanner");
            const iosPrompt = document.getElementById("pwaIosPrompt");
            banner.style.display = "block";
            iosPrompt.style.display = "flex";
          }, 3000);
        }
      });

      // Click su "Installa" (Android)
      const installBtn = document.getElementById("pwaInstallBtn");
      if (installBtn) {
        installBtn.addEventListener("click", async () => {
          if (!deferredInstallPrompt) return;
          deferredInstallPrompt.prompt();
          const { outcome } = await deferredInstallPrompt.userChoice;
          if (outcome === "accepted") {
            document.getElementById("pwaInstallBanner").style.display = "none";
          }
          deferredInstallPrompt = null;
        });
      }

      // ============================================
      // PWA ‚Äî Registrazione Service Worker
      // ============================================
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", async () => {
          try {
            // Rimuovi tutti i vecchi service worker prima di registrare il nuovo
            const regs = await navigator.serviceWorker.getRegistrations();
            for (const reg of regs) {
              const swUrl = reg.active?.scriptURL || "";
              // Forza re-registrazione se il cache name non √® aggiornato
              await reg.update();
            }
            const reg = await navigator.serviceWorker.register("/service-worker.js");
            console.log("[PWA] Service Worker registrato ‚úÖ", reg.scope);
          } catch (err) {
            console.warn("[PWA] Registrazione SW fallita:", err);
          }
        });
      }
    </script>
    <!-- FOOTER LEGALE -->
    <footer
      style="
        display: block;
        max-width: 1400px;
        margin: 32px auto 0;
        padding: 20px 24px;
        text-align: center;
        border-top: 1px solid var(--border-color);
        font-size: 13px;
        color: var(--text-muted);
      "
    >
      <p>
        ¬© 2026 NBA Over Predictor &nbsp;¬∑&nbsp;
        <a
          href="/terms.html"
          style="color: var(--text-secondary); text-decoration: none"
          onmouseover="this.style.color = 'var(--accent-primary)'"
          onmouseout="this.style.color = 'var(--text-secondary)'"
          >Termini di Servizio</a
        >
        &nbsp;¬∑&nbsp;
        <a
          href="/privacy.html"
          style="color: var(--text-secondary); text-decoration: none"
          onmouseover="this.style.color = 'var(--accent-primary)'"
          onmouseout="this.style.color = 'var(--text-secondary)'"
          >Privacy Policy</a
        >
        &nbsp;¬∑&nbsp;
        <a
          href="/cookie.html"
          style="color: var(--text-secondary); text-decoration: none"
          onmouseover="this.style.color = 'var(--accent-primary)'"
          onmouseout="this.style.color = 'var(--text-secondary)'"
          >Cookie Policy</a
        >
      </p>
      <p style="margin-top: 8px; font-size: 12px">
        Strumento di analisi statistica a scopo informativo. Non costituisce
        consulenza finanziaria.
      </p>
    </footer>



    <!-- BANNER INSTALLAZIONE PWA -->
    <div id="pwaInstallBanner" style="
      display: none;
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: linear-gradient(135deg, #1e3a5f, #1a1a2e);
      border-top: 1px solid rgba(59,130,246,0.4);
      padding: 16px 20px;
      z-index: 9999;
      box-shadow: 0 -4px 24px rgba(0,0,0,0.4);
    ">
      <!-- Android / Chrome -->
      <div id="pwaAndroidPrompt" style="display:none; align-items:center; gap:12px;">
        <img src="/logo.png" style="width:40px;height:40px;border-radius:10px;flex-shrink:0;" alt="logo">
        <div style="flex:1;">
          <div style="font-weight:700;font-size:15px;color:#fff;">Installa NBA Over Predictor</div>
          <div style="font-size:12px;color:#93c5fd;margin-top:2px;">Accesso rapido dalla schermata home</div>
        </div>
        <button id="pwaInstallBtn" style="
          background:#3b82f6;color:#fff;border:none;border-radius:8px;
          padding:8px 16px;font-size:13px;font-weight:700;cursor:pointer;flex-shrink:0;
        ">Installa</button>
        <button onclick="dismissPwaBanner()" style="
          background:none;border:none;color:#93c5fd;font-size:20px;cursor:pointer;
          padding:4px;flex-shrink:0;line-height:1;
        ">√ó</button>
      </div>
      <!-- iOS / Safari -->
      <div id="pwaIosPrompt" style="display:none; flex-direction:column; gap:8px;">
        <div style="display:flex;align-items:center;gap:12px;">
          <img src="/logo.png" style="width:40px;height:40px;border-radius:10px;flex-shrink:0;" alt="logo">
          <div style="flex:1;">
            <div style="font-weight:700;font-size:15px;color:#fff;">Installa NBA Over Predictor</div>
            <div style="font-size:12px;color:#93c5fd;margin-top:2px;">Aggiungi alla schermata Home per accesso rapido</div>
          </div>
          <button onclick="dismissPwaBanner()" style="
            background:none;border:none;color:#93c5fd;font-size:20px;cursor:pointer;
            padding:4px;flex-shrink:0;line-height:1;
          ">√ó</button>
        </div>
        <div style="
          background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);
          border-radius:8px;padding:10px 14px;font-size:13px;color:#93c5fd;
          display:flex;align-items:center;gap:8px;
        ">
          <span style="font-size:18px;">‚¨ÜÔ∏è</span>
          <span>Tocca <strong style="color:#fff;">Condividi</strong> poi <strong style="color:#fff;">"Aggiungi a schermata Home"</strong></span>
        </div>
      </div>
    </div>

    <!-- MODAL nuovo progetto -->
    <!-- MODAL (fuori da tutti i view, sempre nel DOM) -->
    <!-- NEW PROJECT MODAL -->
    <div id="newProjectModal" class="modal">
      <div class="modal-content">
        <h2 style="margin-bottom: 24px">Nuovo Progetto</h2>

        <input
          type="text"
          id="projectName"
          class="form-input"
          placeholder="Nome progetto (es. Scalata Febbraio)"
        />
        <input
          type="number"
          id="projectBankroll"
          class="form-input"
          placeholder="Bankroll iniziale (‚Ç¨)"
        />
        <input
          type="number"
          id="projectEvents"
          class="form-input"
          placeholder="Numero eventi totali"
        />
        <input
          type="number"
          id="projectTarget"
          class="form-input"
          placeholder="Profitto target (‚Ç¨)"
        />

        <div style="display: flex; gap: 12px">
          <button
            onclick="closeNewProjectModal()"
            class="btn btn-secondary"
            style="flex: 1"
          >
            Annulla
          </button>
          <button onclick="createNewProject()" class="btn" style="flex: 1">
            Crea Progetto
          </button>
        </div>
      </div>
    </div>

  </body>
</html
>