<!doctype html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NBA Over Predictor â€” Premium</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="/firebase-config.js"></script>
    <!-- PayPal SDK caricato dinamicamente per non esporre il client ID nel codice -->
    <script>
      fetch("/config/paypal-client-id")
        .then((r) => r.json())
        .then((data) => {
          if (!data.client_id) return;
          const script = document.createElement("script");
          script.src = `https://www.paypal.com/sdk/js?client-id=${data.client_id}&currency=EUR&locale=it_IT`;
          script.onload = () => {
            window.paypalReady = true;
          };
          document.head.appendChild(script);
        })
        .catch(() => {});
    </script>
    <link rel="stylesheet" href="css/premium.css" />
  </head>
  <body>
    <a href="/" class="back-link">â† Torna all'app</a>

    <div class="hero">
      <h1>Passa a <span>Premium</span></h1>
      <p>
        Sblocca analisi illimitate e porta la tua strategia al livello
        successivo.
      </p>
    </div>

    <div
      id="alreadyPremium"
      class="already-premium"
      style="max-width: 900px; margin: 0 auto 24px"
    >
      â­ Sei giÃ  un utente Premium! Goditi tutte le funzionalitÃ  senza limiti.
    </div>

    <div class="plans">
      <!-- FREE -->
      <div class="plan-card">
        <div class="plan-name">Free</div>
        <div class="plan-price"><sup>â‚¬</sup>0</div>
        <div class="plan-period">per sempre</div>
        <ul class="features">
          <li><span class="icon">âœ…</span> Analisi scommessa NBA</li>
          <li><span class="icon">âœ…</span> Stake automatico Kelly</li>
          <li><span class="icon">âœ…</span> Storico eventi</li>
          <li><span class="icon">âš ï¸</span> 2 progetti al mese</li>
          <li><span class="icon">âš ï¸</span> 3 ricerche automatiche / giorno</li>
          <li class="disabled">
            <span class="icon">âŒ</span> CSV manuale illimitato
          </li>
        </ul>
        <button class="btn-plan free-btn" onclick="window.location = '/'">
          Piano attuale
        </button>
      </div>

      <!-- PREMIUM -->
      <div class="plan-card featured">
        <div class="featured-badge">â­ CONSIGLIATO</div>
        <div class="plan-name">Premium</div>
        <div class="plan-price"><sup>â‚¬</sup>4,90</div>
        <div class="plan-period">al mese Â· annulla quando vuoi</div>
        <ul class="features">
          <li><span class="icon">âœ…</span> Analisi scommessa NBA</li>
          <li><span class="icon">âœ…</span> Stake automatico Kelly</li>
          <li><span class="icon">âœ…</span> Storico eventi</li>
          <li>
            <span class="icon">âœ…</span> <strong>Progetti illimitati</strong>
          </li>
          <li>
            <span class="icon">âœ…</span>
            <strong>Ricerche automatiche illimitate</strong>
          </li>
          <li>
            <span class="icon">âœ…</span>
            <strong>Badge Premium esclusivo â­</strong>
          </li>
        </ul>
        <button
          class="btn-plan premium-btn"
          id="btnUpgrade"
          onclick="openPaymentModal()"
        >
          ğŸš€ Inizia ora â€” â‚¬4,90/mese
        </button>
      </div>
    </div>

    <div class="security-note">
      ğŸ”’ Pagamenti sicuri tramite Stripe e PayPal &nbsp;Â·&nbsp; Annullabile in
      qualsiasi momento
    </div>

    <!-- PAYMENT MODAL -->
    <div class="modal-overlay" id="paymentModal">
      <div class="payment-modal">
        <h2>ğŸ’³ Scegli come pagare</h2>
        <p class="subtitle">
          NBA Over Predictor Premium â€” â‚¬4,90/mese Â· cancella quando vuoi
        </p>

        <div id="loginRequired" class="login-required">
          âš ï¸ Devi effettuare il login prima di acquistare.
          <br /><a href="/" style="color: #3b82f6; font-weight: 600"
            >Vai all'app e fai Login con Google â†’</a
          >
        </div>

        <div class="payment-options" id="paymentOptions">
          <!-- STRIPE -->
          <button class="btn-stripe" id="btnStripe" onclick="payWithStripe()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
              <path
                d="M13.479 9.883c-1.626-.604-2.512-.931-2.512-1.618 0-.604.543-.931 1.358-.931 1.086 0 2.173.362 3.086.966l.453-2.790C14.950 5.166 13.696 5 12.441 5 9.566 5 7.608 6.569 7.608 9.087c0 2.397 1.596 3.207 3.492 3.811 1.506.483 2.180.845 2.180 1.568 0 .724-.604 1.086-1.567 1.086-1.267 0-2.534-.483-3.620-1.267L7.700 16.980C8.907 17.826 10.473 18.250 12.038 18.250c3.086 0 5.138-1.508 5.138-4.147 0-2.518-1.627-3.448-3.697-4.220z"
              />
            </svg>
            Paga con Carta (Stripe)
          </button>

          <div class="divider">oppure</div>

          <!-- PAYPAL -->
          <div id="paypal-button-container"></div>
        </div>

        <!-- Success -->
        <div class="success-box" id="successBox">
          <h3>ğŸ‰ Benvenuto in Premium!</h3>
          <p>
            Il tuo piano Ã¨ stato aggiornato. Ricarica l'app per vedere tutte le
            funzionalitÃ  sbloccate.
          </p>
          <a href="/">Vai all'app â†’</a>
        </div>

        <span class="close-modal" onclick="closePaymentModal()">Ã— Annulla</span>
      </div>
    </div>

    <script>
      let auth = null;
      let currentUser = null;

      // Init Firebase
      window.addEventListener("DOMContentLoaded", () => {
        if (typeof firebase !== "undefined" && firebase.apps.length) {
          auth = firebase.auth();
          auth.onAuthStateChanged((user) => {
            currentUser = user;
            onAuthReady(user);
          });
        }

        // Controlla query param ?payment=success
        const params = new URLSearchParams(window.location.search);
        if (params.get("payment") === "success") {
          showSuccess();
        }
      });

      function onAuthReady(user) {
        if (user) {
          // Controlla se giÃ  premium
          if (typeof firebase !== "undefined") {
            firebase
              .firestore()
              .collection("users")
              .doc(user.uid)
              .get()
              .then((snap) => {
                if (snap.exists && snap.data().plan === "premium") {
                  document.getElementById("alreadyPremium").style.display =
                    "block";
                  document.getElementById("btnUpgrade").disabled = true;
                  document.getElementById("btnUpgrade").innerText =
                    "âœ… GiÃ  Premium";
                }
              });
          }
        }
      }

      function openPaymentModal() {
        document.getElementById("paymentModal").classList.add("active");

        if (!currentUser) {
          document.getElementById("loginRequired").style.display = "block";
          document.getElementById("paymentOptions").style.display = "none";
          return;
        }

        document.getElementById("loginRequired").style.display = "none";
        document.getElementById("paymentOptions").style.display = "flex";
        initPayPalButton();
      }

      function closePaymentModal() {
        document.getElementById("paymentModal").classList.remove("active");
      }

      // Chiudi cliccando fuori
      document.getElementById("paymentModal").addEventListener("click", (e) => {
        if (e.target === document.getElementById("paymentModal"))
          closePaymentModal();
      });

      // â”€â”€ STRIPE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      async function payWithStripe() {
        if (!currentUser) return;
        const btn = document.getElementById("btnStripe");
        btn.disabled = true;
        btn.innerText = "â³ Reindirizzamento...";

        try {
          const res = await fetch("/stripe/create-checkout", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              uid: currentUser.uid,
              email: currentUser.email,
            }),
          });
          const data = await res.json();
          if (data.url) {
            window.location.href = data.url;
          } else {
            alert("Errore: " + (data.error || "Riprova"));
            btn.disabled = false;
            btn.innerText = "Paga con Carta (Stripe)";
          }
        } catch (e) {
          alert("Errore di rete: " + e.message);
          btn.disabled = false;
          btn.innerText = "Paga con Carta (Stripe)";
        }
      }

      // â”€â”€ PAYPAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      let paypalInited = false;

      function initPayPalButton() {
        if (paypalInited) return;
        if (typeof paypal === "undefined") {
          // SDK ancora in caricamento â€” riprova ogni secondo fino a 10 volte
          if (!window.paypalRetries) window.paypalRetries = 0;
          if (window.paypalRetries < 10) {
            window.paypalRetries++;
            setTimeout(initPayPalButton, 1000);
          } else {
            document.getElementById("paypal-button-container").innerHTML =
              '<p style="color:#555;font-size:13px;text-align:center;">PayPal non disponibile al momento.</p>';
          }
          return;
        }
        paypalInited = true;

        paypal
          .Buttons({
            style: {
              layout: "horizontal",
              color: "gold",
              shape: "rect",
              label: "paypal",
              height: 50,
            },

            createOrder: async () => {
              const res = await fetch("/paypal/create-order", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ uid: currentUser.uid }),
              });
              const data = await res.json();
              if (data.error) throw new Error(data.error);
              return data.id;
            },

            onApprove: async (data) => {
              const res = await fetch("/paypal/capture-order", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  order_id: data.orderID,
                  uid: currentUser.uid,
                }),
              });
              const result = await res.json();
              if (result.success) {
                showSuccess();
              } else {
                alert("Pagamento non completato. Riprova.");
              }
            },

            onError: (err) => {
              console.error("PayPal error:", err);
              alert("Errore PayPal. Riprova o usa la carta.");
            },
          })
          .render("#paypal-button-container");
      }

      function showSuccess() {
        document.getElementById("paymentModal").classList.add("active");
        document.getElementById("paymentOptions").style.display = "none";
        document.getElementById("loginRequired").style.display = "none";
        document.getElementById("successBox").style.display = "block";
      }
    </script>
  </body>
</html>
